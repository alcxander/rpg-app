import { NextRequest, NextResponse } from "next/server"
import { auth } from "@clerk/nextjs/server"
import { createClient } from "@/lib/supabaseAdmin"

export async function GET(req: NextRequest) {
  const { userId } = auth()
  if (!userId) return NextResponse.json({ error: "Unauthorized" }, { status: 401 })
  const supabase = createClient()
  const { searchParams } = new URL(req.url)
  const campaignId = searchParams.get("campaignId")
  if (!campaignId) return NextResponse.json({ error: "campaignId required" }, { status: 400 })

  const { data: camp } = await supabase.from("campaigns").select("id, owner_id").eq("id", campaignId).single()
  if (!camp || camp.owner_id !== userId) return NextResponse.json({ error: "Forbidden" }, { status: 403 })

  const { data: rows, error } = await supabase.from("players_gold").select("player_id, gold_amount").eq("campaign_id", campaignId)
  if (error) return NextResponse.json({ error: "Failed to load" }, { status: 500 })
  return NextResponse.json({ ok: true, rows })
}
